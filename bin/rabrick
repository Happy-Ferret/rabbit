#!/usr/bin/env ruby
# -*- ruby -*-

require "webrick"

require 'tofu/tofulet'
require 'drb/drb'

require "rabbit/console"
require "rabbit/div/tofu"

def parse(args=ARGV, logger=nil)
  Rabbit::Console.parse!(args, logger) do |opts, options|
    options.druby_uri = "druby://localhost:10101"
    options.port = 10102


    opts.separator ""

    opts.on("--druby-uri [URI]",
            _("Specify Rabbit's dRuby URI as [URI]."),
            "(#{options.druby_uri})") do |uri|
      options.druby_uri = uri
    end

    opts.on("--port [PORT]",
            Integer,
            _("Specify WEBrick port as [PORT]."),
            "(#{options.port})") do |port|
      options.port = port
    end
  end
end

def main(monolithic=true)
  options, logger = parse
  
  DRb.start_service

  logger.webrick_mode = true
  
  server = WEBrick::HTTPServer.new(:Port => options.port,
                                   :AddressFamily => Socket::AF_INET,
                                   :Logger => logger)

  rabbit = DRbObject.new_with_uri(options.druby_uri)
  comment_rabbit = DRbObject.new_with_uri("druby://localhost:10105")
  Rabbit::Div::TofuSession.rabbit = rabbit
  Rabbit::Div::TofuSession.comment_rabbit = comment_rabbit
  bartender = Tofu::Bartender.new(Rabbit::Div::TofuSession)
  server.mount("/", WEBrick::Tofulet, bartender)

  trap("INT") {server.shutdown}
  server.start
end

main
