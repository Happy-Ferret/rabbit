#!/usr/bin/env ruby
# -*- ruby -*-

require "fileutils"

require "rabbit/console"

def parse(args=ARGV, logger=nil)
  Rabbit::Console.parse!(args, logger) do |opts, options|
    options.output_dir = "theme-doc"
    options.locale_dir = nil
    options.locales = %w(en ja fr)


    opts.separator ""
    
    opts.on("-I", "--include [PATH]",
            _("Add [PATH] to load path.")) do |path|
      $LOAD_PATH.unshift(path)
    end
    
    opts.separator ""
    
    opts.on("-o", "--output-dir [DIR]",
            _("Specify output directory as [DIR].")) do |dir|
      options.output_dir = dir
    end
    
    opts.separator ""
    
    opts.on("--locales [LOC1,LOC2,...]",
            _("Specify target locales as [LOC1,LOC2,...]."),
            "([#{options.locales.join(', ')}])") do |locales|
      options.locales = locales
    end
  end
end

def main
  options, logger = parse
  
  require 'rabbit/theme'

  current_locale = Rabbit::Locale.get
  
  themes = Rabbit::Theme::Searcher.collect_theme
  options.locales.each do |locale|
    Rabbit::GetText.locale = current_locale
    logger.info(_("Generating documents for locale <%s>...") % locale)
    Rabbit::GetText.locale = locale
    output_dir = File.join(options.output_dir, locale)
    FileUtils.mkdir_p(output_dir)
    themes.each do |theme|
      file = File.join(output_dir, "#{theme.base_name}.rd")
      File.open(file, "w") do |f|
        f.print(theme.to_rd)
      end
    end
  end
end

main
